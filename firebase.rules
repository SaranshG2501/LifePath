
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isTeacher(classroomData) {
      return isAuthenticated() && request.auth.uid == classroomData.teacherId;
    }
    
    function isMember(classroomData) {
      return isAuthenticated() && 
             classroomData.members != null &&
             request.auth.uid in classroomData.members;
    }
    
    function isStudentInClass(classroomData) {
      return isAuthenticated() && 
             classroomData.students != null &&
             classroomData.students.hasAny([{'id': request.auth.uid}]);
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
      
      // Allow updating classrooms field when joining/leaving
      allow update: if isAuthenticated() && 
                     request.resource.data.diff(resource.data).affectedKeys().hasOnly(['classrooms']);
    }
    
    // Classrooms collection
    match /classrooms/{classroomId} {
      // Read access
      allow read: if isAuthenticated();
      
      // Create access - only teachers
      allow create: if isAuthenticated() && 
                     request.resource.data.teacherId == request.auth.uid;
      
      // Update access - FIXED for student removal
      allow update: if isAuthenticated() && 
                     (isTeacher(resource.data) ||  // Teacher can update anything including student removal
                      // Student can join by adding themselves to members/students arrays  
                      (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members', 'students']) &&
                       request.resource.data.get('members', []).hasAll(resource.data.get('members', [])) &&
                       request.resource.data.get('members', []).size() <= resource.data.get('members', []).size() + 1) ||
                      // Student can remove themselves from classroom (leave)
                      (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members', 'students']) &&
                       resource.data.get('members', []).hasAll(request.resource.data.get('members', [])) &&
                       resource.data.get('members', []).size() == request.resource.data.get('members', []).size() + 1 &&
                       !(request.auth.uid in request.resource.data.get('members', [])) &&
                       (request.auth.uid in resource.data.get('members', []))) ||
                      // System updates for sessions and classroom metadata
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['activeSessionId', 'activeScenario', 'currentScene', 'lastActivity']) ||
                      // Allow lastUpdated field to be modified
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastUpdated']) ||
                      // Combined updates with lastUpdated
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['activeSessionId', 'activeScenario', 'currentScene', 'lastActivity', 'lastUpdated']) ||
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members', 'students', 'lastUpdated']));
                      
      // Delete access - only teachers
      allow delete: if isAuthenticated() && isTeacher(resource.data);
      
      // Votes subcollection
      match /votes/{voteId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && voteId == request.auth.uid;
      }
    }
    
    // Live Sessions collection (renamed from liveSessions)
    match /sessions/{sessionId} {
      // Create access - only teachers
      allow create: if isAuthenticated() && 
                     request.resource.data.teacherId == request.auth.uid;
      
      // Read access - anyone authenticated
      allow read: if isAuthenticated();
      
      // Update access
      allow update: if isAuthenticated() && 
                     (resource.data.teacherId == request.auth.uid ||  // Teacher can update
                      // Students can join and submit choices
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['participants', 'currentChoices', 'lastUpdated']));
      
      // Delete access - only teachers
      allow delete: if isAuthenticated() && resource.data.teacherId == request.auth.uid;
    }
    
    // Session Participants
    match /sessionParticipants/{participantId} {
      allow create: if isAuthenticated() && 
                     request.resource.data.studentId == request.auth.uid;
      allow read: if isAuthenticated();
      allow update: if isAuthenticated() && 
                     (resource.data.studentId == request.auth.uid ||
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isActive']));
      allow delete: if isAuthenticated() && resource.data.studentId == request.auth.uid;
    }
    
    // Notifications
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.studentId == request.auth.uid;
      // Allow teachers to create notifications for students (session started/ended)
      allow create: if isAuthenticated();
      // Allow students to update their own notifications (mark as read)
      allow update: if isAuthenticated() && resource.data.studentId == request.auth.uid;
      allow delete: if isAuthenticated();
    }
    
    // Classroom Messages
    match /classroomMessages/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.senderId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.senderId == request.auth.uid;
    }
    
    // Class codes (for joining classrooms)
    match /classCodes/{code} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
  }
}
